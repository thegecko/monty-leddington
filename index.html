<!DOCTYPE html>
<html>
<head>
    <title>monty-leddington</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- Origin Trial Token, feature = Web Bluetooth, origin = https://thegecko.github.io, expires = 2016-11-03-->
    <meta http-equiv="origin-trial" content="AjXpKVmFDQu9AWN9lkhuMlKAFY1HiQN25Ai+4++K8ZWIwAHMaoBoz7hma8WJJzJ0a2PHwv2HZMHyjuErB4DEJwsAAABdeyJvcmlnaW4iOiAiaHR0cHM6Ly90aGVnZWNrby5naXRodWIuaW86NDQzIiwgImZlYXR1cmUiOiAiV2ViQmx1ZXRvb3RoIiwgImV4cGlyeSI6IDE0NzgyMDYyMTd9" />
    <link rel="import" href="bower_components/color-picker-element/dist/color-picker.html">
    <style>
        html, body { width: 100%; padding: 0; margin: 0; }
        button { font-size: 50px; padding: 0 20px; display: block; margin: 20px auto; }
        color-picker { display: none; margin: auto; }
        #off { width: 250px; display: none; margin: 20px auto; }
    </style>
</head>
<body>
    <button id="connect">Connect</button>
    <div id="container"></div>
    <button id="off">Off</button>
    <div id="results"></div>

    <script>
        var serviceUUID = "00009866-0000-1000-8000-00805f9b34fb";
        var controlUUID = "0000a001-0000-1000-8000-00805f9b34fb";

        var size = Math.min(window.innerWidth, window.innerHeight);
        var connectEl = document.getElementById("connect");
        var containerEl = document.getElementById("container");
        var offEl = document.getElementById("off");
        var resultsEl = document.getElementById("results");
        var ledChar = null;

        containerEl.innerHTML += '<color-picker width="' + size + '" height="' + size + '"></color-picker>';

        var colorEl = document.querySelector("color-picker");
        colorEl.style.width = size + "px";

        function log(message) {
            console.log(message);
            resultsEl.innerText += message + "\n";
        }

        if (navigator.bluetooth.referringDevice) {
            connect(navigator.bluetooth.referringDevice);
        }

        function connect(device) {
            device.gatt.connect()
            .then(server => server.getPrimaryService(serviceUUID))
            .then(service => service.getCharacteristic(controlUUID))
            .then(characteristic => {
                ledChar = characteristic;
                connectEl.style.display = "none";
                colorEl.style.display = "block";
                offEl.style.display = "block";
            })
            .catch(error => {
                log(error);
            });
        }

        connectEl.addEventListener("click", () => {
            navigator.bluetooth.requestDevice({
                filters: [{ services: [serviceUUID] }]
            })
            .then(device => connect(device))
            .catch(error => {
                log(error);
            });
        });

        colorEl.addEventListener("colorselected", e => {
            var rgb = e.detail.rgb;
            setColour(rgb);
        });

        offEl.addEventListener("click", e => {
            setColour({
                r: 0,
                g: 0,
                b: 0,
                a: 0
            });
        });

        function setColour(rgb) {
            if (ledChar) {
                rgb.a = rgb.a || 100;

                var buffer = new ArrayBuffer(4);
                var view = new DataView(buffer);
                view.setUint8(0, rgb.b);
                view.setUint8(1, rgb.g);
                view.setUint8(2, rgb.r);
                view.setUint8(3, rgb.a);

                ledChar.writeValue(view)
                .catch(error => {
                    // log(error);
                });
            }
        }
    </script>
</body>
</html>
